import React, { Component } from 'react';
import PropTypes from 'prop-types';
import './react-carousel.scss';

class Carousel extends Component {

  static propTypes = {
    children: PropTypes.oneOfType([
      PropTypes.array,
      PropTypes.object
    ]),
    transitionTime: PropTypes.number,
    dots: PropTypes.bool,
    arrows: PropTypes.bool,
    autoPlay: PropTypes.bool,
    autoplaySpeed: PropTypes.number,
  };

  static defaultProps = {
    transitionTime: 500,
    autoplaySpeed: 5000,
    autoPlay: true,
    dots: true,
    arrows: true,
  };

  state = {
    selectedItem: 0,
    wrapperWidth: 0,
  };

  componentDidMount = () => {
    this.checkLenghtOfChildren();
    this.computeWrapperWidth();
    this.bindEvents();
    this.autoPlay();
  };

  componentWillUnmount = () =>
    this.unBindEvents();

  debounce = (fun, mil) => () => {
    clearTimeout(this.timer);
    this.timer = setTimeout(() => {
      fun();
    }, mil);
  }

  checkLenghtOfChildren = () => {
    if (!this.props.children || (this.props.children.length === 0)) {
      return null;
    }
    if (this.props.children && !this.props.children.length) {
      return null;
    }
    return true;
  };

  handleChangeSlide = (index, clickedOnLeftArrow) => {
    this.handleClearIntervalAutoPlay();
    let currentSlide = index;
    if (this.state.selectedItem === (this.props.children.length - 1) && !clickedOnLeftArrow) {
      currentSlide = 0;
    } else if (index < 0) {
      currentSlide = (this.props.children.length - 1);
    }
    this.setState({
      selectedItem: currentSlide
    }, () =>
      this.autoPlay());
  };

  bindEvents = () => {
    window.addEventListener('resize', this.computeWrapperWidth);
  };

  unBindEvents = () => {
    window.removeEventListener('resize', this.computeWrapperWidth);
    this.handleClearIntervalAutoPlay();
  };

  autoPlay = () => {
    if (this.props.autoPlay) {
      this.autoPlayInterval = setInterval(() =>
      this.handleChangeSlide(this.state.selectedItem + 1), this.props.autoplaySpeed);
      return this.autoPlayInterval;
    }
    return null;
  };

  handleClearIntervalAutoPlay = () =>
    clearInterval(this.autoPlayInterval);

  computeWrapperWidth = () => {
    const w = this.wrapper && this.wrapper.offsetWidth;
    if (w) {
      this.setState({
        wrapperWidth: w
      });
    }
  };

  renderItems = () =>
  this.props.children.map((item, index) =>
    (<li key={index} className="react-carousel-item" style={{ width: this.state.wrapperWidth || 0 }}>{item}</li>));

  renderDots = () =>
  this.props.children.map((item, index) =>
    (<li
      key={index}
      onClick={() => this.handleChangeSlide(index)}
      className={`dot${this.state.selectedItem === index ? ' active' : ''}`}
    />));

  renderArrows = () =>
    [<li
      key="left-arrow"
      className="left-arrow icon-left-open center-vertical"
      onClick={this.debounce(() => {
        if (this.state.selectedItem === (this.props.children.length - 1)) {
          return this.handleChangeSlide(this.props.children.length - 2, true);
        }
        return this.handleChangeSlide(this.state.selectedItem - 1);
      }, 40)}
    />,
      <li
        key="right-arrow"
        className="right-arrow icon-right-open center-vertical"
        onClick={this.debounce(() => this.handleChangeSlide(this.state.selectedItem + 1), 40)}
      />];

  render() {
    if (!this.checkLenghtOfChildren()) {
      return null;
    }


    const position = this.state.selectedItem === 0 ? '0px' : `${-(this.state.wrapperWidth * this.state.selectedItem)}px`;
    const transformValue = `translate3d(${position},0,0)`;
    const transitionTime = `${this.props.transitionTime}ms`;
    const ulStyle = {
      WebkitTransform: transformValue,
      MozTransform: transformValue,
      MsTransform: transformValue,
      OTransform: transformValue,
      transform: transformValue,
      msTransform: transformValue,
      WebkitTransitionDuration: transitionTime,
      MozTransitionDuration: transitionTime,
      MsTransitionDuration: transitionTime,
      OTransitionDuration: transitionTime,
      transitionDuration: transitionTime,
      msTransitionDuration: transitionTime,
      width: this.state.wrapperWidth * this.props.children.length
    };
    return (
      <div className="react-carousel-wrapper" ref={(ref) => { this.wrapper = ref; }}>
        <div className="react-carousel-railroad">
          <ul className="react-carousel-stage" style={ulStyle}>
            {this.renderItems()}
          </ul>
          {this.props.arrows &&
          <ul className="react-carousel-arrows center-vertical">
            {this.renderArrows()}
          </ul>
        }
        </div>
        {this.props.dots &&
          <ul className="react-carousel-dots">
            {this.renderDots()}
          </ul>
        }
      </div>

    );
  }
}
export default Carousel;
