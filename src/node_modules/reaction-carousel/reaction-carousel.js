import React, { Component } from 'react';
import PropTypes from 'prop-types';
import './reaction-carousel.scss';

export default class Carousel extends Component {

  static propTypes = {
    children: PropTypes.oneOfType([
      PropTypes.array,
      PropTypes.object
    ]),
    transitionTime: PropTypes.number,
    dots: PropTypes.bool,
    arrows: PropTypes.bool,
    autoPlay: PropTypes.bool,
    autoplaySpeed: PropTypes.number,
    loop: PropTypes.bool,
    draggable: PropTypes.bool,
    slidesToShow: PropTypes.number,
  };

  static defaultProps = {
    transitionTime: 500,
    autoplaySpeed: 5000,
    autoPlay: true,
    dots: true,
    arrows: true,
    loop: false,
    draggable: false,
    slidesToShow: 1,
  };

  state = {
    selectedItem: 0,
    wrapperWidth: 0,
    slideWidth: 0,
    clientX: 0
  };

  componentDidMount = () => {
    this.checkLenghtOfChildren();
    this.computeWrapperWidth();
    this.bindEvents();
    // this.autoPlay();
  };

  componentWillUnmount = () =>
    this.unBindEvents();

  items = [];

  debounce = (fun, mil) => () => {
    clearTimeout(this.timer);
    this.timer = setTimeout(() => {
      fun();
    }, mil);
  };

  mouseMove = ({ clientX }) =>
    this.setState({
      clientX
    });

  checkLenghtOfChildren = () => {
    if (!this.props.children || (this.props.children.length === 0)) {
      return null;
    }
    if (this.props.children && !this.props.children.length) {
      return null;
    }
    return true;
  };

  handleChangeSlide = (index, clickedOnControlls, clickedOnLeftArrow) => {
    const { children, slidesToShow, loop } = this.props;

    let currentSlide = index;
    if (loop) {
      if (index === (slidesToShow + (children.length - (slidesToShow - 1)))) {
        currentSlide = 0;
      }
    } else if ((children.length - slidesToShow) < (index) && !clickedOnLeftArrow) {
      currentSlide = 0;
    }
    if (index < 0) {
      currentSlide = children.length - slidesToShow;
    }

    return this.setState({
      selectedItem: currentSlide,
    }, () => {
      if (clickedOnControlls) {
        this.handleClearIntervalAutoPlay();
        this.autoPlay();
      }
    });
  };

  bindEvents = () => {
    this.initForDrag();
    window.addEventListener('resize', this.debounce(this.computeWrapperWidth, 400));
  };

  unBindEvents = () => {
    window.removeEventListener('resize', this.computeWrapperWidth);
    this.handleClearIntervalAutoPlay();
  };

  autoPlay = () => {
    if (this.props.autoPlay) {
      this.autoPlayInterval = setInterval(() =>
        this.handleChangeSlide(this.state.selectedItem + 1), this.props.autoplaySpeed);
      return this.autoPlayInterval;
    }
    return null;
  };

  handleClearIntervalAutoPlay = () =>
    clearInterval(this.autoPlayInterval);

  computeWrapperWidth = () => {
    const w = this.wrapper && this.wrapper.offsetWidth;
    if (w) {
      this.setState({
        wrapperWidth: w,
        slideWidth: (w / this.props.slidesToShow) || w
      });
    }
  };

  initForDrag = () => {
    if (this.props.draggable) {
      this.items.forEach(item =>
      item.addEventListener('mousedown', () =>
        window.addEventListener('mousemove', this.mouseMove)));
      window.addEventListener('mouseup', () =>
      window.removeEventListener('mousemove', this.mouseMove));
    }
  };

  renderItems = () =>
  [...this.props.children, ...(this.props.children.slice(0, this.props.slidesToShow))].map((item, index) =>
    (<li
      key={index}
      ref={(ref) => { this.items[index] = ref; }}
      className={`reaction-carousel-item${this.state.selectedItem === index ? ' active' : ''}`}
      style={{ width: this.state.slideWidth }}
    >
      {item}
    </li>));

  renderDots = () => {
    const LENGTH = this.props.slidesToShow === 1 ? this.props.children.length : (this.props.children.length) - (this.props.slidesToShow - 1);
    const els = [];
    for (let index = 0; index < LENGTH; index += 1) {
      // (this.props.children.length + index)
      els.push(<li
        key={index}
        onClick={() => this.handleChangeSlide(index, true)}
        className={`dot${(this.state.selectedItem === index) || (this.state.selectedItem === 0 && index === 0) ? ' active' : ''}`}
      />);
    }
    return els;
  };

  renderArrows = () =>
    [<li
      key="left-arrow"
      className="left-arrow icon-left-open center-vertical"
      onClick={this.debounce(() => {
        if (this.state.selectedItem === (this.props.children.length - 1)) {
          return this.handleChangeSlide(this.props.children.length - 2, true, true);
        }
        return this.handleChangeSlide(this.state.selectedItem - 1);
      }, 40)}
    />,
      <li
        key="right-arrow"
        className="right-arrow icon-right-open center-vertical"
        onClick={this.debounce(() => this.handleChangeSlide(this.state.selectedItem + 1, true), 40)}
      />];

  render() {
    if (!this.checkLenghtOfChildren()) {
      return null;
    }
    const position = this.state.selectedItem === 0 ? '0' : `${-(this.state.slideWidth * this.state.selectedItem)}`;
    let transformValue = `translate3d(${position}px,0,0)`;
    if (this.state.clientX) {
      const vv = `${-((this.state.slideWidth * this.state.selectedItem) + (this.state.clientX))}px`;
      transformValue = `translate3d(${vv},0,0)`;
    }
    let transitionTime = `${this.props.transitionTime}ms`;
    if (this.state.selectedItem === (this.props.children.length + 1) || this.state.selectedItem === 0) {
      transitionTime = `${0}ms`;
    }
    const ulStyle = {
      WebkitTransform: transformValue,
      MozTransform: transformValue,
      MsTransform: transformValue,
      OTransform: transformValue,
      transform: transformValue,
      msTransform: transformValue,
      WebkitTransitionDuration: transitionTime,
      MozTransitionDuration: transitionTime,
      MsTransitionDuration: transitionTime,
      OTransitionDuration: transitionTime,
      transitionDuration: transitionTime,
      msTransitionDuration: transitionTime,
      width: (this.state.wrapperWidth * (this.props.children.length + this.props.slidesToShow))
    };
    return (
      <div className="reaction-carousel-wrapper" ref={(ref) => { this.wrapper = ref; }}>
        <div className="reaction-carousel-railroad">
          <ul className="reaction-carousel-stage" style={ulStyle}>
            {this.renderItems()}
          </ul>
          {this.props.arrows &&
          <ul className="reaction-carousel-arrows center-vertical">
            {this.renderArrows()}
          </ul>
        }
        </div>
        {this.props.dots &&
          <ul className="reaction-carousel-dots">
            {this.renderDots()}
          </ul>
        }
      </div>

    );
  }
}
